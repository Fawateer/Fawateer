<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فواتير - نظام إدارة متكامل</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/jsbarcode/dist/JsBarcode.all.min.js"></script>
    <style>
        :root {
            --primary: #6C63FF;
            --primary-dark: #554FD8;
            --secondary: #FF6584;
            --accent: #42E2B8;
            --dark: #0F0F1E;
            --darker: #080811;
            --dark-light: #1A1A2E;
            --text: #F0F0F0;
            --text-secondary: #B0B0C0;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --success: #2ECC71;
            --warning: #F39C12;
            --danger: #E74C3C;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --radius: 16px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--text);
            min-height: 100vh;
            direction: rtl;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header & Navigation */
        .header {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 800;
            color: white;
        }

        .logo-text {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius);
            padding: 5px;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
            font-weight: 600;
        }

        .nav-tab:hover {
            background: var(--glass);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
        }

        .nav-tab svg {
            width: 20px;
            height: 20px;
        }

        /* Main Content */
        .main-content {
            margin-top: 30px;
            display: none;
        }

        .main-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Glassmorphism Cards */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            border: 1px solid var(--glass-border);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .glass-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .card-title {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title svg {
            width: 24px;
            height: 24px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--dark-light);
            color: var(--text);
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: var(--dark);
            border-color: var(--primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 14px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text);
            font-size: 16px;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.2);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid var(--glass-border);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .data-table th {
            background: var(--dark-light);
            padding: 16px;
            text-align: right;
            font-weight: 700;
            border-bottom: 1px solid var(--glass-border);
        }

        .data-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--glass-border);
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--dark-light) 0%, rgba(42, 42, 72, 0.8) 100%);
            border-radius: var(--radius);
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            border: 1px solid transparent;
            transition: var(--transition);
        }

        .stat-card:hover {
            border-color: var(--primary);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Barcode Scanner */
        .scanner-container {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: var(--darker);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .scanner-container.active {
            display: flex;
        }

        .scanner-frame {
            width: 80%;
            max-width: 500px;
            height: 300px;
            border: 3px solid var(--primary);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.8);
        }

        .scanner-line {
            position: absolute;
            width: 100%;
            height: 3px;
            background: var(--primary);
            top: 50%;
            animation: scan 2s infinite linear;
        }

        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }

        .scanner-result {
            margin-top: 30px;
            background: var(--glass);
            padding: 20px;
            border-radius: var(--radius);
            max-width: 500px;
            width: 80%;
            text-align: center;
        }

        /* POS Cart */
        .pos-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .cart-items {
            background: var(--glass);
            border-radius: var(--radius);
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .cart-summary {
            background: var(--glass);
            border-radius: var(--radius);
            padding: 24px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--glass-border);
        }

        .summary-total {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }

        /* Receipt */
        .receipt {
            background: white;
            color: black;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            margin: 0 auto;
            font-family: 'Cairo', sans-serif;
            direction: rtl;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #000;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .receipt-items {
            margin-bottom: 20px;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .receipt-total {
            border-top: 2px solid #000;
            padding-top: 15px;
            margin-top: 20px;
            font-weight: 800;
            font-size: 20px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .pos-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .nav-tabs {
                overflow-x: auto;
                padding: 5px;
            }
            
            .nav-tab {
                padding: 10px 15px;
                font-size: 14px;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .mb-20 { margin-bottom: 20px; }
        .mt-20 { margin-top: 20px; }
        .mb-30 { margin-bottom: 30px; }
        .mt-30 { margin-top: 30px; }
        .d-none { display: none; }
        .d-flex { display: flex; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .w-100 { width: 100%; }
        .gap-10 { gap: 10px; }
        .gap-20 { gap: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="logo-container">
                <div class="logo">ف</div>
                <div class="logo-text">فواتير</div>
            </div>
            
            <div class="nav-tabs">
                <div class="nav-tab active" data-tab="dashboard">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                    </svg>
                    <span>لوحة التحكم</span>
                </div>
                <div class="nav-tab" data-tab="pos">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6h-2c0-2.76-2.24-5-5-5S7 3.24 7 6H5c-1.1 0-1.99.9-1.99 2L3 20c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-7-3c1.66 0 3 1.34 3 3H9c0-1.66 1.34-3 3-3zm0 10c-2.76 0-5-2.24-5-5h2c0 1.66 1.34 3 3 3s3-1.34 3-3h2c0 2.76-2.24 5-5 5z"/>
                    </svg>
                    <span>نقطة البيع</span>
                </div>
                <div class="nav-tab" data-tab="inventory">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H4v-4h11v4zm0-5H4V9h11v4zm5 5h-4V9h4v9z"/>
                    </svg>
                    <span>المخزون</span>
                </div>
                <div class="nav-tab" data-tab="barcode">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2 6h4v12H2zm5 0h4v12H7zm5 0h4v12h-4zm5 0h4v12h-4z"/>
                    </svg>
                    <span>ماسح الباركود</span>
                </div>
                <div class="nav-tab" data-tab="reports">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                    </svg>
                    <span>التقارير</span>
                </div>
                <div class="nav-tab" data-tab="customers">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                    </svg>
                    <span>دفتر الزبائن</span>
                </div>
                <div class="nav-tab" data-tab="settings">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                    </svg>
                    <span>الإعدادات</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard -->
        <div id="dashboard" class="main-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);">
                        <svg viewBox="0 0 24 24" fill="white" width="32" height="32">
                            <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalSales">0 ر.س</div>
                        <div class="stat-label">إجمالي المبيعات اليوم</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, var(--success) 0%, #27AE60 100%);">
                        <svg viewBox="0 0 24 24" fill="white" width="32" height="32">
                            <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zm-5-2h3l2.25 3H15V6zM7 18c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm12 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalProfit">0 ر.س</div>
                        <div class="stat-label">الأرباح اليومية</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, var(--warning) 0%, #E67E22 100%);">
                        <svg viewBox="0 0 24 24" fill="white" width="32" height="32">
                            <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="lowStock">0</div>
                        <div class="stat-label">منتجات منخفضة المخزون</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, var(--secondary) 0%, #E84393 100%);">
                        <svg viewBox="0 0 24 24" fill="white" width="32" height="32">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalCustomers">0</div>
                        <div class="stat-label">إجمالي الزبائن</div>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="glass-card" style="flex: 2;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                            </svg>
                            <span>مبيعات آخر 7 أيام</span>
                        </h3>
                    </div>
                    <canvas id="salesChart" height="250"></canvas>
                </div>
                <div class="glass-card" style="flex: 1;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                                <path d="M11 2v20c-5.07-.5-9-4.79-9-10s3.93-9.5 9-10zm2.03 0v8.99H22c-.47-4.74-4.24-8.52-8.97-8.99zm0 11.01V22c4.74-.47 8.5-4.25 8.97-8.99h-8.97z"/>
                            </svg>
                            <span>توزيع المبيعات</span>
                        </h3>
                    </div>
                    <canvas id="pieChart" height="250"></canvas>
                </div>
            </div>

            <div class="glass-card mt-30">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                            <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zm-5-2h3l2.25 3H15V6zM7 18c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm12 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
                        </svg>
                        <span>أحدث المبيعات</span>
                    </h3>
                    <button class="btn btn-primary" onclick="loadTab('pos')">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        <span>بيع جديد</span>
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>الزبون</th>
                                <th>الإجمالي</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="recentSales">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- POS System -->
        <div id="pos" class="main-content">
            <div class="pos-container">
                <div>
                    <div class="glass-card mb-20">
                        <div class="card-header">
                            <h3 class="card-title">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                                    <path d="M19 6h-2c0-2.76-2.24-5-5-5S7 3.24 7 6H5c-1.1 0-1.99.9-1.99 2L3 20c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-7-3c1.66 0 3 1.34 3 3H9c0-1.66 1.34-3 3-3zm0 10c-2.76 0-5-2.24-5-5h2c0 1.66 1.34 3 3 3s3-1.34 3-3h2c0 2.76-2.24 5-5 5z"/>
                                </svg>
                                <span>نقطة البيع</span>
                            </h3>
                            <div class="d-flex gap-10">
                                <button class="btn btn-secondary" onclick="openScanner()">
                                    <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                        <path d="M2 6h4v12H2zm5 0h4v12H7zm5 0h4v12h-4zm5 0h4v12h-4z"/>
                                    </svg>
                                    <span>مسح باركود</span>
                                </button>
                                <button class="btn btn-secondary" onclick="clearCart()">
                                    <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                    </svg>
                                    <span>تفريغ السلة</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">البحث بالاسم أو الباركود</label>
                                <input type="text" class="form-control" id="productSearch" placeholder="اكتب اسم المنتج أو الباركود" onkeyup="searchProducts()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">الزبون</label>
                                <select class="form-control" id="customerSelect">
                                    <option value="walkin">زبون مباشر</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>المنتج</th>
                                        <th>السعر</th>
                                        <th>الكمية</th>
                                        <th>المجموع</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="cartItems">
                                    <!-- Cart items will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="glass-card">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">إضافة منتج جديد</label>
                                <select class="form-control" id="productSelect" onchange="addToCartFromSelect()">
                                    <option value="">اختر منتج للإضافة</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">الكمية</label>
                                <input type="number" class="form-control" id="productQty" value="1" min="1">
                            </div>
                        </div>
                        <button class="btn btn-primary w-100" onclick="addProductManually()">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                            <span>إضافة منتج للسلة</span>
                        </button>
                    </div>
                </div>
                
                <div class="cart-summary">
                    <h3 class="card-title mb-20">ملخص الفاتورة</h3>
                    
                    <div class="summary-row">
                        <span>الإجمالي الفرعي:</span>
                        <span id="subtotal">0 ر.س</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">الضريبة (%)</label>
                            <input type="number" class="form-control" id="taxRate" value="15" min="0" max="100" onchange="updateTotals()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">الخصم (ر.س)</label>
                            <input type="number" class="form-control" id="discount" value="0" min="0" onchange="updateTotals()">
                        </div>
                    </div>
                    
                    <div class="summary-row">
                        <span>الضريبة:</span>
                        <span id="taxAmount">0 ر.س</span>
                    </div>
                    
                    <div class="summary-row">
                        <span>الخصم:</span>
                        <span id="discountAmount">0 ر.س</span>
                    </div>
                    
                    <div class="summary-row">
                        <span>الإجمالي النهائي:</span>
                        <span class="summary-total" id="totalAmount">0 ر.س</span>
                    </div>
                    
                    <div class="form-group mt-20">
                        <label class="form-label">طريقة الدفع</label>
                        <select class="form-control" id="paymentMethod">
                            <option value="cash">نقدي</option>
                            <option value="card">بطاقة ائتمان</option>
                            <option value="transfer">تحويل بنكي</option>
                        </select>
                    </div>
                    
                    <div class="form-group mt-20">
                        <label class="form-label">المبلغ المدفوع</label>
                        <input type="number" class="form-control" id="amountPaid" value="0" min="0" onchange="updateChange()">
                    </div>
                    
                    <div class="summary-row">
                        <span>الباقي:</span>
                        <span id="changeAmount">0 ر.س</span>
                    </div>
                    
                    <div class="d-flex gap-10 mt-30">
                        <button class="btn btn-success" style="flex: 1;" onclick="completeSale()">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                            </svg>
                            <span>إتمام البيع</span>
                        </button>
                        <button class="btn btn-secondary" onclick="generateReceipt()">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                            </svg>
                            <span>طباعة</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Management -->
        <div id="inventory" class="main-content">
            <div class="glass-card mb-20">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H4v-4h11v4zm0-5H4V9h11v4zm5 5h-4V9h4v9z"/>
                        </svg>
                        <span>إدارة المخزون</span>
                    </h3>
                    <button class="btn btn-primary" onclick="openProductModal()">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        <span>إضافة منتج</span>
                    </button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">بحث في المخزون</label>
                        <input type="text" class="form-control" id="inventorySearch" placeholder="ابحث بالاسم، الباركود أو الفئة" onkeyup="searchInventory()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">تصفية حسب الفئة</label>
                        <select class="form-control" id="categoryFilter" onchange="filterInventory()">
                            <option value="">جميع الفئات</option>
                            <option value="سوبرماركت">سوبرماركت</option>
                            <option value="أدوات كهربائية">أدوات كهربائية</option>
                            <option value="مواد بناء">مواد بناء</option>
                            <option value="أجهزة إلكترونية">أجهزة إلكترونية</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>الصورة</th>
                                <th>الاسم</th>
                                <th>الفئة</th>
                                <th>السعر</th>
                                <th>المخزون</th>
                                <th>الباركود</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable">
                            <!-- Inventory items will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Barcode Scanner -->
        <div id="barcode" class="main-content">
            <div class="glass-card text-center">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                            <path d="M2 6h4v12H2zm5 0h4v12H7zm5 0h4v12h-4zm5 0h4v12h-4z"/>
                        </svg>
                        <span>ماسح الباركود</span>
                    </h3>
                </div>
                
                <div style="padding: 40px 0;">
                    <div style="width: 300px; height: 300px; margin: 0 auto 40px; background: var(--dark-light); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="var(--primary)" width="100" height="100">
                            <path d="M2 6h4v12H2zm5 0h4v12H7zm5 0h4v12h-4zm5 0h4v12h-4z"/>
                        </svg>
                    </div>
                    
                    <p class="mb-20">انقر على الزر لفتح ماسح الباركود للتحقق من الأسعار والمخزون فورياً</p>
                    
                    <button class="btn btn-primary" onclick="openScanner()" style="padding: 15px 40px; font-size: 18px;">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                            <path d="M2 6h4v12H2zm5 0h4v12H7zm5 0h4v12h-4zm5 0h4v12h-4z"/>
                        </svg>
                        <span>فتح الماسح الضوئي</span>
                    </button>
                </div>
            </div>
            
            <div class="glass-card mt-30">
                <div class="card-header">
                    <h3 class="card-title">نتائج المسح الأخيرة</h3>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>الوقت</th>
                                <th>المنتج</th>
                                <th>الباركود</th>
                                <th>السعر</th>
                                <th>المخزون</th>
                            </tr>
                        </thead>
                        <tbody id="scanHistory">
                            <!-- Scan history will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports -->
        <div id="reports" class="main-content">
            <div class="glass-card mb-20">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                        </svg>
                        <span>التقارير والتحليلات</span>
                    </h3>
                    <div class="d-flex gap-10">
                        <select class="form-control" style="width: auto;" id="reportPeriod" onchange="loadReports()">
                            <option value="week">أسبوع</option>
                            <option value="month">شهر</option>
                            <option value="year">سنة</option>
                        </select>
                        <button class="btn btn-secondary" onclick="exportReport()">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                            <span>تصدير التقرير</span>
                        </button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="glass-card" style="flex: 1;">
                        <h4 class="card-title mb-20">المبيعات اليومية</h4>
                        <canvas id="dailySalesChart" height="200"></canvas>
                    </div>
                    <div class="glass-card" style="flex: 1;">
                        <h4 class="card-title mb-20">أفضل المنتجات مبيعاً</h4>
                        <canvas id="topProductsChart" height="200"></canvas>
                    </div>
                </div>
                
                <div class="glass-card mt-20">
                    <h4 class="card-title mb-20">تقرير المبيعات التفصيلي</h4>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>عدد الفواتير</th>
                                    <th>إجمالي المبيعات</th>
                                    <th>متوسط الفاتورة</th>
                                    <th>الضرائب</th>
                                    <th>صافي الربح</th>
                                </tr>
                            </thead>
                            <tbody id="reportTable">
                                <!-- Report data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Ledger -->
        <div id="customers" class="main-content">
            <div class="glass-card mb-20">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                            <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                        </svg>
                        <span>دفتر الزبائن</span>
                    </h3>
                    <button class="btn btn-primary" onclick="openCustomerModal()">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        <span>إضافة زبون</span>
                    </button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">بحث في الزبائن</label>
                        <input type="text" class="form-control" id="customerSearch" placeholder="ابحث بالاسم أو الهاتف" onkeyup="searchCustomers()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">حالة الحساب</label>
                        <select class="form-control" id="customerStatusFilter" onchange="filterCustomers()">
                            <option value="">جميع الحسابات</option>
                            <option value="active">حسابات نشطة</option>
                            <option value="debt">مدينون</option>
                            <option value="credit">دائنون</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>الاسم</th>
                                <th>الهاتف</th>
                                <th>البريد الإلكتروني</th>
                                <th>الرصيد</th>
                                <th>آخر معاملة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="customersTable">
                            <!-- Customers will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="glass-card">
                <div class="card-header">
                    <h3 class="card-title">سجل المدفوعات</h3>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>الزبون</th>
                                <th>المبلغ</th>
                                <th>نوع المعاملة</th>
                                <th>الطريقة</th>
                                <th>الفاتورة المرجعية</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTable">
                            <!-- Payments will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div id="settings" class="main-content">
            <div class="form-row">
                <div class="glass-card" style="flex: 1;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                                <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                            </svg>
                            <span>إعدادات النظام</span>
                        </h3>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">اسم المتجر</label>
                        <input type="text" class="form-control" id="storeName" placeholder="أدخل اسم متجرك">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">العنوان</label>
                        <textarea class="form-control" id="storeAddress" rows="3" placeholder="أدخل عنوان متجرك"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">رقم الهاتف</label>
                        <input type="text" class="form-control" id="storePhone" placeholder="أدخل رقم الهاتف">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">نسبة الضريبة (%)</label>
                        <input type="number" class="form-control" id="defaultTax" placeholder="النسبة الافتراضية للضريبة">
                    </div>
                    
                    <button class="btn btn-primary w-100 mt-20" onclick="saveSettings()">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                            <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                        </svg>
                        <span>حفظ الإعدادات</span>
                    </button>
                </div>
                
                <div class="glass-card" style="flex: 1;">
                    <div class="card-header">
                        <h3 class="card-title">إدارة البيانات</h3>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">تصدير البيانات</label>
                        <p class="text-secondary" style="font-size: 14px; margin-bottom: 10px;">قم بتصدير جميع بيانات النظام إلى ملف JSON للنسخ الاحتياطي</p>
                        <button class="btn btn-secondary w-100" onclick="exportData()">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                            <span>تصدير جميع البيانات</span>
                        </button>
                    </div>
                    
                    <div class="form-group mt-20">
                        <label class="form-label">استيراد البيانات</label>
                        <p class="text-secondary" style="font-size: 14px; margin-bottom: 10px;">استيراد بيانات من ملف JSON. تحذير: هذا سوف يستبدل البيانات الحالية!</p>
                        <input type="file" class="form-control" id="importFile" accept=".json">
                        <button class="btn btn-warning w-100 mt-10" onclick="importData()">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
                            </svg>
                            <span>استيراد البيانات</span>
                        </button>
                    </div>
                    
                    <div class="form-group mt-20">
                        <label class="form-label">إعادة تعيين النظام</label>
                        <p class="text-secondary" style="font-size: 14px; margin-bottom: 10px;">تحذير: هذه العملية ستحذف جميع البيانات ولا يمكن التراجع عنها!</p>
                        <button class="btn btn-danger w-100" onclick="resetSystem()">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                            <span>حذف جميع البيانات</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="glass-card mt-30">
                <div class="card-header">
                    <h3 class="card-title">معلومات النظام</h3>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">الإصدار</label>
                        <p>فواتير - النسخة 2.1.0</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">عدد المنتجات</label>
                        <p id="productsCount">0</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">عدد الفواتير</label>
                        <p id="invoicesCount">0</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">عدد الزبائن</label>
                        <p id="customersCount">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Overlay -->
    <div id="scannerOverlay" class="scanner-container">
        <div class="scanner-frame">
            <div class="scanner-line"></div>
        </div>
        <div class="scanner-result d-none" id="scannerResult">
            <h3>نتيجة المسح</h3>
            <div id="scannedProductInfo"></div>
            <button class="btn btn-primary mt-20" onclick="closeScanner()">إغلاق الماسح</button>
        </div>
        <button class="btn btn-danger mt-30" onclick="closeScanner()">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
            <span>إغلاق الماسح</span>
        </button>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="scanner-container" style="display: none;">
        <div class="glass-card" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="card-header">
                <h3 class="card-title" id="productModalTitle">إضافة منتج جديد</h3>
                <button class="btn btn-secondary btn-small" onclick="closeProductModal()">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">اسم المنتج *</label>
                <input type="text" class="form-control" id="modalProductName" placeholder="أدخل اسم المنتج">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">الفئة *</label>
                    <select class="form-control" id="modalProductCategory">
                        <option value="سوبرماركت">سوبرماركت</option>
                        <option value="أدوات كهربائية">أدوات كهربائية</option>
                        <option value="مواد بناء">مواد بناء</option>
                        <option value="أجهزة إلكترونية">أجهزة إلكترونية</option>
                        <option value="ملابس">ملابس</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">السعر (ر.س) *</label>
                    <input type="number" class="form-control" id="modalProductPrice" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">الكمية في المخزون *</label>
                    <input type="number" class="form-control" id="modalProductQuantity" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">حد المخزون المنخفض</label>
                    <input type="number" class="form-control" id="modalProductLowStock" placeholder="10" min="0">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">باركود</label>
                    <div class="d-flex gap-10">
                        <input type="text" class="form-control" id="modalProductBarcode" placeholder="أدخل رقم الباركود">
                        <button class="btn btn-secondary" onclick="generateBarcode()">إنشاء</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">سعر الشراء (ر.س)</label>
                    <input type="number" class="form-control" id="modalProductCost" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">وصف المنتج</label>
                <textarea class="form-control" id="modalProductDescription" rows="3" placeholder="أدخل وصف للمنتج"></textarea>
            </div>
            
            <div class="d-flex gap-10 mt-30">
                <button class="btn btn-primary" style="flex: 1;" onclick="saveProduct()">حفظ المنتج</button>
                <button class="btn btn-secondary" onclick="closeProductModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="scanner-container" style="display: none;">
        <div class="glass-card" style="max-width: 500px; width: 90%;">
            <div class="card-header">
                <h3 class="card-title" id="customerModalTitle">إضافة زبون جديد</h3>
                <button class="btn btn-secondary btn-small" onclick="closeCustomerModal()">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">اسم الزبون *</label>
                <input type="text" class="form-control" id="modalCustomerName" placeholder="أدخل اسم الزبون">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">رقم الهاتف *</label>
                    <input type="text" class="form-control" id="modalCustomerPhone" placeholder="أدخل رقم الهاتف">
                </div>
                <div class="form-group">
                    <label class="form-label">البريد الإلكتروني</label>
                    <input type="email" class="form-control" id="modalCustomerEmail" placeholder="أدخل البريد الإلكتروني">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">العنوان</label>
                <textarea class="form-control" id="modalCustomerAddress" rows="2" placeholder="أدخل عنوان الزبون"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">الرصيد الافتتاحي (ر.س)</label>
                    <input type="number" class="form-control" id="modalCustomerBalance" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">نوع الرصيد</label>
                    <select class="form-control" id="modalBalanceType">
                        <option value="debt">مدين (عليه ديون)</option>
                        <option value="credit">دائن (له رصيد)</option>
                    </select>
                </div>
            </div>
            
            <div class="d-flex gap-10 mt-30">
                <button class="btn btn-primary" style="flex: 1;" onclick="saveCustomer()">حفظ الزبون</button>
                <button class="btn btn-secondary" onclick="closeCustomerModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="scanner-container" style="display: none;">
        <div class="glass-card" style="max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="card-header">
                <h3 class="card-title">فاتورة البيع</h3>
                <div class="d-flex gap-10">
                    <button class="btn btn-secondary btn-small" onclick="printReceipt()">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                            <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                        </svg>
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="closeReceiptModal()">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="receiptContent"></div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="scanner-container" style="display: none; align-items: flex-start; padding-top: 100px;">
        <div class="glass-card" style="max-width: 400px; width: 90%;">
            <div class="card-header">
                <h3 class="card-title" id="alertTitle">تنبيه</h3>
            </div>
            <p id="alertMessage" class="mb-20"></p>
            <button class="btn btn-primary w-100" onclick="closeAlertModal()">موافق</button>
        </div>
    </div>

    <script>
        // Initialize data structures
        let products = JSON.parse(localStorage.getItem('fawateer_products')) || [];
        let customers = JSON.parse(localStorage.getItem('fawateer_customers')) || [];
        let invoices = JSON.parse(localStorage.getItem('fawateer_invoices')) || [];
        let settings = JSON.parse(localStorage.getItem('fawateer_settings')) || {
            storeName: "متجر فواتير",
            storeAddress: "الرياض، المملكة العربية السعودية",
            storePhone: "+966 500 000 000",
            defaultTax: 15
        };
        let scanHistory = JSON.parse(localStorage.getItem('fawateer_scan_history')) || [];
        let cart = [];
        let currentProductId = null;
        let currentCustomerId = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Load settings
            loadSettings();
            
            // Initialize data
            initSampleData();
            
            // Load dashboard data
            updateDashboard();
            
            // Load inventory table
            loadInventoryTable();
            
            // Load customer select for POS
            loadCustomerSelect();
            
            // Load product select for POS
            loadProductSelect();
            
            // Load customers table
            loadCustomersTable();
            
            // Load payments table
            loadPaymentsTable();
            
            // Load reports
            loadReports();
            
            // Set up navigation
            setupNavigation();
            
            // Update system info
            updateSystemInfo();
        });

        // Initialize with sample data if empty
        function initSampleData() {
            if (products.length === 0) {
                products = [
                    {
                        id: 1,
                        name: "أرز بسمتي 5 كجم",
                        category: "سوبرماركت",
                        price: 25.99,
                        cost: 18.50,
                        quantity: 50,
                        lowStock: 10,
                        barcode: "6297001507783",
                        description: "أرز بسمتي عالي الجودة"
                    },
                    {
                        id: 2,
                        name: "سخان مياه كهربائي",
                        category: "أدوات كهربائية",
                        price: 450.00,
                        cost: 320.00,
                        quantity: 12,
                        lowStock: 3,
                        barcode: "8850015501234",
                        description: "سخان مياه سعة 50 لتر"
                    },
                    {
                        id: 3,
                        name: "أسمنت أبيض 50 كجم",
                        category: "مواد بناء",
                        price: 55.00,
                        cost: 40.00,
                        quantity: 200,
                        lowStock: 20,
                        barcode: "6223006719023",
                        description: "أسمنت أبيض للبناء والديكور"
                    },
                    {
                        id: 4,
                        name: "هاتف ذكي",
                        category: "أجهزة إلكترونية",
                        price: 2499.99,
                        cost: 1850.00,
                        quantity: 8,
                        lowStock: 2,
                        barcode: "8806092610012",
                        description: "هاتف ذكي بشاشة 6.7 بوصة"
                    },
                    {
                        id: 5,
                        name: "زيت طهي 5 لتر",
                        category: "سوبرماركت",
                        price: 42.50,
                        cost: 30.00,
                        quantity: 35,
                        lowStock: 8,
                        barcode: "6291100456789",
                        description: "زيت نباتي للطهي"
                    }
                ];
                saveProducts();
            }
            
            if (customers.length === 0) {
                customers = [
                    {
                        id: 1,
                        name: "أحمد محمد",
                        phone: "0550123456",
                        email: "ahmed@example.com",
                        address: "الرياض - حي الملز",
                        balance: 0,
                        balanceType: "debt",
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: "سعيد عبدالله",
                        phone: "0567891234",
                        email: "saeed@example.com",
                        address: "جدة - حي الصفا",
                        balance: 150.75,
                        balanceType: "credit",
                        createdAt: new Date().toISOString()
                    }
                ];
                saveCustomers();
            }
            
            if (invoices.length === 0) {
                // Add some sample invoices for the past 7 days
                const today = new Date();
                for (let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    
                    invoices.push({
                        id: 1000 + i,
                        date: date.toISOString(),
                        customerId: i % 2 === 0 ? 1 : 2,
                        customerName: i % 2 === 0 ? "أحمد محمد" : "سعيد عبدالله",
                        items: [
                            { productId: 1, name: "أرز بسمتي 5 كجم", price: 25.99, quantity: 2, total: 51.98 },
                            { productId: 5, name: "زيت طهي 5 لتر", price: 42.50, quantity: 1, total: 42.50 }
                        ],
                        subtotal: 94.48,
                        tax: 14.17,
                        discount: 0,
                        total: 108.65,
                        paymentMethod: i % 2 === 0 ? "cash" : "card",
                        amountPaid: i % 2 === 0 ? 110 : 108.65,
                        change: i % 2 === 0 ? 1.35 : 0,
                        status: "completed"
                    });
                }
                saveInvoices();
            }
            
            // Save scan history if empty
            if (scanHistory.length === 0) {
                scanHistory = [
                    {
                        timestamp: new Date(Date.now() - 3600000).toISOString(),
                        barcode: "6297001507783",
                        productName: "أرز بسمتي 5 كجم",
                        price: 25.99,
                        quantity: 50
                    },
                    {
                        timestamp: new Date(Date.now() - 7200000).toISOString(),
                        barcode: "8850015501234",
                        productName: "سخان مياه كهربائي",
                        price: 450.00,
                        quantity: 12
                    }
                ];
                saveScanHistory();
            }
        }

        // Setup navigation between tabs
        function setupNavigation() {
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Update active tab
                    navTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding content
                    document.querySelectorAll('.main-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    
                    // Load specific data for the tab
                    if (tabId === 'dashboard') updateDashboard();
                    else if (tabId === 'inventory') loadInventoryTable();
                    else if (tabId === 'customers') {
                        loadCustomersTable();
                        loadPaymentsTable();
                    }
                    else if (tabId === 'reports') loadReports();
                });
            });
        }

        // Load a specific tab
        function loadTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.nav-tab[data-tab="${tabId}"]`).classList.add('active');
            
            document.querySelectorAll('.main-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            
            // Load specific data for the tab
            if (tabId === 'dashboard') updateDashboard();
            else if (tabId === 'inventory') loadInventoryTable();
            else if (tabId === 'customers') {
                loadCustomersTable();
                loadPaymentsTable();
            }
            else if (tabId === 'reports') loadReports();
        }

        // Update dashboard statistics and charts
        function updateDashboard() {
            // Calculate totals
            const today = new Date().toDateString();
            const todaySales = invoices.filter(inv => {
                const invDate = new Date(inv.date).toDateString();
                return invDate === today;
            });
            
            const totalSales = todaySales.reduce((sum, inv) => sum + inv.total, 0);
            const totalProfit = todaySales.reduce((sum, inv) => {
                const profit = inv.items.reduce((itemSum, item) => {
                    const product = products.find(p => p.id === item.productId);
                    const cost = product ? product.cost * item.quantity : 0;
                    return itemSum + (item.total - cost);
                }, 0);
                return sum + profit;
            }, 0);
            
            const lowStockCount = products.filter(p => p.quantity <= p.lowStock).length;
            
            // Update stats
            document.getElementById('totalSales').textContent = totalSales.toFixed(2) + ' ر.س';
            document.getElementById('totalProfit').textContent = totalProfit.toFixed(2) + ' ر.س';
            document.getElementById('lowStock').textContent = lowStockCount;
            document.getElementById('totalCustomers').textContent = customers.length;
            
            // Load recent sales
            loadRecentSales();
            
            // Load charts
            loadDashboardCharts();
        }

        // Load recent sales for dashboard
        function loadRecentSales() {
            const recentSalesTable = document.getElementById('recentSales');
            recentSalesTable.innerHTML = '';
            
            // Get last 5 invoices
            const recentInvoices = [...invoices]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            recentInvoices.forEach(invoice => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>#${invoice.id}</td>
                    <td>${new Date(invoice.date).toLocaleDateString('ar-SA')}</td>
                    <td>${invoice.customerName}</td>
                    <td>${invoice.total.toFixed(2)} ر.س</td>
                    <td><span style="color: var(--success); font-weight: 600;">مكتمل</span></td>
                `;
                recentSalesTable.appendChild(row);
            });
        }

        // Load dashboard charts
        function loadDashboardCharts() {
            // Sales chart for last 7 days
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            const dates = [];
            const salesData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toLocaleDateString('ar-SA', { weekday: 'short' }));
                
                const daySales = invoices.filter(inv => {
                    const invDate = new Date(inv.date).toDateString();
                    return invDate === date.toDateString();
                }).reduce((sum, inv) => sum + inv.total, 0);
                
                salesData.push(daySales);
            }
            
            if (window.salesChart) window.salesChart.destroy();
            
            window.salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'المبيعات',
                        data: salesData,
                        borderColor: 'var(--primary)',
                        backgroundColor: 'rgba(108, 99, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'var(--text-secondary)' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'var(--text-secondary)' }
                        }
                    }
                }
            });
            
            // Pie chart for categories
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            const categories = {};
            
            invoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (product) {
                        categories[product.category] = (categories[product.category] || 0) + item.total;
                    }
                });
            });
            
            const categoryLabels = Object.keys(categories);
            const categoryData = Object.values(categories);
            const colors = ['#6C63FF', '#FF6584', '#42E2B8', '#F39C12', '#E74C3C', '#9B59B6'];
            
            if (window.pieChart) window.pieChart.destroy();
            
            window.pieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: categoryData,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'left',
                            labels: { color: 'var(--text)' }
                        }
                    }
                }
            });
        }

        // Load inventory table
        function loadInventoryTable() {
            const inventoryTable = document.getElementById('inventoryTable');
            inventoryTable.innerHTML = '';
            
            products.forEach(product => {
                const lowStockClass = product.quantity <= product.lowStock ? 'style="color: var(--warning); font-weight: 600;"' : '';
                const barcodeSvg = `<svg width="80" height="40"><path d="M5,10 L15,10 L15,30 L5,30 Z M20,10 L30,10 L30,30 L20,30 Z M35,10 L45,10 L45,30 L35,30 Z M50,10 L60,10 L60,30 L50,30 Z" fill="#000"/></svg>`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><div style="width: 50px; height: 50px; background: var(--dark-light); border-radius: 8px; display: flex; align-items: center; justify-content: center;">${barcodeSvg}</div></td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${product.price.toFixed(2)} ر.س</td>
                    <td><span ${lowStockClass}>${product.quantity}</span></td>
                    <td>${product.barcode}</td>
                    <td>
                        <div class="d-flex gap-10">
                            <button class="btn btn-secondary btn-small" onclick="editProduct(${product.id})">تعديل</button>
                            <button class="btn btn-danger btn-small" onclick="deleteProduct(${product.id})">حذف</button>
                        </div>
                    </td>
                `;
                inventoryTable.appendChild(row);
            });
        }

        // Search inventory
        function searchInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.barcode.includes(searchTerm) ||
                product.category.toLowerCase().includes(searchTerm)
            );
            
            const inventoryTable = document.getElementById('inventoryTable');
            inventoryTable.innerHTML = '';
            
            filteredProducts.forEach(product => {
                const lowStockClass = product.quantity <= product.lowStock ? 'style="color: var(--warning); font-weight: 600;"' : '';
                const barcodeSvg = `<svg width="80" height="40"><path d="M5,10 L15,10 L15,30 L5,30 Z M20,10 L30,10 L30,30 L20,30 Z M35,10 L45,10 L45,30 L35,30 Z M50,10 L60,10 L60,30 L50,30 Z" fill="#000"/></svg>`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><div style="width: 50px; height: 50px; background: var(--dark-light); border-radius: 8px; display: flex; align-items: center; justify-content: center;">${barcodeSvg}</div></td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${product.price.toFixed(2)} ر.س</td>
                    <td><span ${lowStockClass}>${product.quantity}</span></td>
                    <td>${product.barcode}</td>
                    <td>
                        <div class="d-flex gap-10">
                            <button class="btn btn-secondary btn-small" onclick="editProduct(${product.id})">تعديل</button>
                            <button class="btn btn-danger btn-small" onclick="deleteProduct(${product.id})">حذف</button>
                        </div>
                    </td>
                `;
                inventoryTable.appendChild(row);
            });
        }

        // Filter inventory by category
        function filterInventory() {
            const category = document.getElementById('categoryFilter').value;
            const filteredProducts = category ? 
                products.filter(product => product.category === category) : 
                products;
            
            const inventoryTable = document.getElementById('inventoryTable');
            inventoryTable.innerHTML = '';
            
            filteredProducts.forEach(product => {
                const lowStockClass = product.quantity <= product.lowStock ? 'style="color: var(--warning); font-weight: 600;"' : '';
                const barcodeSvg = `<svg width="80" height="40"><path d="M5,10 L15,10 L15,30 L5,30 Z M20,10 L30,10 L30,30 L20,30 Z M35,10 L45,10 L45,30 L35,30 Z M50,10 L60,10 L60,30 L50,30 Z" fill="#000"/></svg>`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><div style="width: 50px; height: 50px; background: var(--dark-light); border-radius: 8px; display: flex; align-items: center; justify-content: center;">${barcodeSvg}</div></td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${product.price.toFixed(2)} ر.س</td>
                    <td><span ${lowStockClass}>${product.quantity}</span></td>
                    <td>${product.barcode}</td>
                    <td>
                        <div class="d-flex gap-10">
                            <button class="btn btn-secondary btn-small" onclick="editProduct(${product.id})">تعديل</button>
                            <button class="btn btn-danger btn-small" onclick="deleteProduct(${product.id})">حذف</button>
                        </div>
                    </td>
                `;
                inventoryTable.appendChild(row);
            });
        }

        // Open product modal for adding/editing
        function openProductModal(productId = null) {
            currentProductId = productId;
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productModalTitle');
            
            if (productId) {
                // Edit mode
                title.textContent = 'تعديل المنتج';
                const product = products.find(p => p.id === productId);
                
                if (product) {
                    document.getElementById('modalProductName').value = product.name;
                    document.getElementById('modalProductCategory').value = product.category;
                    document.getElementById('modalProductPrice').value = product.price;
                    document.getElementById('modalProductQuantity').value = product.quantity;
                    document.getElementById('modalProductLowStock').value = product.lowStock;
                    document.getElementById('modalProductBarcode').value = product.barcode;
                    document.getElementById('modalProductCost').value = product.cost || '';
                    document.getElementById('modalProductDescription').value = product.description || '';
                }
            } else {
                // Add mode
                title.textContent = 'إضافة منتج جديد';
                document.getElementById('modalProductName').value = '';
                document.getElementById('modalProductCategory').value = 'سوبرماركت';
                document.getElementById('modalProductPrice').value = '';
                document.getElementById('modalProductQuantity').value = '0';
                document.getElementById('modalProductLowStock').value = '10';
                document.getElementById('modalProductBarcode').value = '';
                document.getElementById('modalProductCost').value = '';
                document.getElementById('modalProductDescription').value = '';
            }
            
            modal.style.display = 'flex';
        }

        // Close product modal
        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
            currentProductId = null;
        }

        // Save product
        function saveProduct() {
            const name = document.getElementById('modalProductName').value;
            const category = document.getElementById('modalProductCategory').value;
            const price = parseFloat(document.getElementById('modalProductPrice').value);
            const quantity = parseInt(document.getElementById('modalProductQuantity').value);
            const lowStock = parseInt(document.getElementById('modalProductLowStock').value);
            const barcode = document.getElementById('modalProductBarcode').value;
            const cost = parseFloat(document.getElementById('modalProductCost').value) || 0;
            const description = document.getElementById('modalProductDescription').value;
            
            // Validation
            if (!name || !category || isNaN(price) || isNaN(quantity)) {
                showAlert('خطأ', 'يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            if (currentProductId) {
                // Update existing product
                const index = products.findIndex(p => p.id === currentProductId);
                if (index !== -1) {
                    products[index] = {
                        ...products[index],
                        name,
                        category,
                        price,
                        quantity,
                        lowStock,
                        barcode: barcode || products[index].barcode,
                        cost,
                        description
                    };
                }
            } else {
                // Add new product
                const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                const newProduct = {
                    id: newId,
                    name,
                    category,
                    price,
                    cost,
                    quantity,
                    lowStock,
                    barcode: barcode || generateBarcodeNumber(),
                    description,
                    createdAt: new Date().toISOString()
                };
                products.push(newProduct);
            }
            
            saveProducts();
            loadInventoryTable();
            loadProductSelect();
            updateDashboard();
            closeProductModal();
            
            showAlert('تم', 'تم حفظ المنتج بنجاح');
        }

        // Delete product
        function deleteProduct(productId) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                products = products.filter(p => p.id !== productId);
                saveProducts();
                loadInventoryTable();
                loadProductSelect();
                updateDashboard();
                showAlert('تم', 'تم حذف المنتج بنجاح');
            }
        }

        // Edit product
        function editProduct(productId) {
            openProductModal(productId);
        }

        // Generate barcode number
        function generateBarcodeNumber() {
            return '8' + Math.floor(100000000000 + Math.random() * 900000000000).toString().substring(1);
        }

        // Generate barcode for modal
        function generateBarcode() {
            document.getElementById('modalProductBarcode').value = generateBarcodeNumber();
        }

        // Load product select for POS
        function loadProductSelect() {
            const productSelect = document.getElementById('productSelect');
            productSelect.innerHTML = '<option value="">اختر منتج للإضافة</option>';
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} - ${product.price.toFixed(2)} ر.س (${product.quantity} متبقي)`;
                productSelect.appendChild(option);
            });
        }

        // Load customer select for POS
        function loadCustomerSelect() {
            const customerSelect = document.getElementById('customerSelect');
            customerSelect.innerHTML = '<option value="walkin">زبون مباشر</option>';
            
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} - ${customer.phone}`;
                customerSelect.appendChild(option);
            });
        }

        // Add product to cart from select
        function addToCartFromSelect() {
            const productSelect = document.getElementById('productSelect');
            const productId = parseInt(productSelect.value);
            
            if (!productId) return;
            
            const qty = parseInt(document.getElementById('productQty').value) || 1;
            addToCart(productId, qty);
            
            // Reset select
            productSelect.value = '';
            document.getElementById('productQty').value = 1;
        }

        // Add product manually to cart
        function addProductManually() {
            const productSelect = document.getElementById('productSelect');
            const productId = parseInt(productSelect.value);
            
            if (!productId) {
                showAlert('خطأ', 'يرجى اختيار منتج أولاً');
                return;
            }
            
            const qty = parseInt(document.getElementById('productQty').value) || 1;
            addToCart(productId, qty);
            
            // Reset select
            productSelect.value = '';
            document.getElementById('productQty').value = 1;
        }

        // Add product to cart
        function addToCart(productId, quantity = 1) {
            const product = products.find(p => p.id === productId);
            
            if (!product) {
                showAlert('خطأ', 'المنتج غير موجود');
                return;
            }
            
            if (product.quantity < quantity) {
                showAlert('خطأ', `الكمية المطلوبة غير متوفرة. المتوفر: ${product.quantity}`);
                return;
            }
            
            // Check if product already in cart
            const existingItemIndex = cart.findIndex(item => item.productId === productId);
            
            if (existingItemIndex !== -1) {
                // Update quantity
                const newQty = cart[existingItemIndex].quantity + quantity;
                
                if (product.quantity < newQty) {
                    showAlert('خطأ', `الكمية المطلوبة غير متوفرة. المتوفر: ${product.quantity}`);
                    return;
                }
                
                cart[existingItemIndex].quantity = newQty;
                cart[existingItemIndex].total = cart[existingItemIndex].price * newQty;
            } else {
                // Add new item
                cart.push({
                    productId,
                    name: product.name,
                    price: product.price,
                    quantity,
                    total: product.price * quantity
                });
            }
            
            updateCartDisplay();
            updateTotals();
        }

        // Update cart display
        function updateCartDisplay() {
            const cartItemsTable = document.getElementById('cartItems');
            cartItemsTable.innerHTML = '';
            
            cart.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price.toFixed(2)} ر.س</td>
                    <td>
                        <div class="d-flex align-center gap-10">
                            <button class="btn btn-secondary btn-small" onclick="updateCartItemQuantity(${index}, -1)">-</button>
                            <span>${item.quantity}</span>
                            <button class="btn btn-secondary btn-small" onclick="updateCartItemQuantity(${index}, 1)">+</button>
                        </div>
                    </td>
                    <td>${item.total.toFixed(2)} ر.س</td>
                    <td>
                        <button class="btn btn-danger btn-small" onclick="removeFromCart(${index})">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </td>
                `;
                cartItemsTable.appendChild(row);
            });
        }

        // Update cart item quantity
        function updateCartItemQuantity(index, change) {
            const item = cart[index];
            const product = products.find(p => p.id === item.productId);
            
            const newQty = item.quantity + change;
            
            if (newQty < 1) {
                removeFromCart(index);
                return;
            }
            
            if (product.quantity < newQty) {
                showAlert('خطأ', `الكمية المطلوبة غير متوفرة. المتوفر: ${product.quantity}`);
                return;
            }
            
            cart[index].quantity = newQty;
            cart[index].total = cart[index].price * newQty;
            
            updateCartDisplay();
            updateTotals();
        }

        // Remove item from cart
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartDisplay();
            updateTotals();
        }

        // Clear cart
        function clearCart() {
            if (cart.length === 0) return;
            
            if (confirm('هل تريد تفريغ سلة المشتريات؟')) {
                cart = [];
                updateCartDisplay();
                updateTotals();
            }
        }

        // Update totals
        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + item.total, 0);
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            
            const taxAmount = subtotal * (taxRate / 100);
            const total = subtotal + taxAmount - discount;
            
            document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' ر.س';
            document.getElementById('taxAmount').textContent = taxAmount.toFixed(2) + ' ر.س';
            document.getElementById('discountAmount').textContent = discount.toFixed(2) + ' ر.س';
            document.getElementById('totalAmount').textContent = total.toFixed(2) + ' ر.س';
            
            updateChange();
        }

        // Update change amount
        function updateChange() {
            const total = parseFloat(document.getElementById('totalAmount').textContent) || 0;
            const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
            const change = amountPaid - total;
            
            document.getElementById('changeAmount').textContent = change.toFixed(2) + ' ر.س';
            
            // Change color based on change
            const changeElement = document.getElementById('changeAmount');
            if (change < 0) {
                changeElement.style.color = 'var(--danger)';
            } else {
                changeElement.style.color = 'var(--success)';
            }
        }

        // Complete sale
        function completeSale() {
            if (cart.length === 0) {
                showAlert('خطأ', 'سلة المشتريات فارغة');
                return;
            }
            
            const total = parseFloat(document.getElementById('totalAmount').textContent);
            const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
            
            if (amountPaid < total) {
                showAlert('خطأ', 'المبلغ المدفوع أقل من الإجمالي');
                return;
            }
            
            // Create invoice
            const invoiceId = invoices.length > 0 ? Math.max(...invoices.map(i => i.id)) + 1 : 1000;
            const customerId = document.getElementById('customerSelect').value;
            let customerName = 'زبون مباشر';
            
            if (customerId !== 'walkin') {
                const customer = customers.find(c => c.id === parseInt(customerId));
                if (customer) customerName = customer.name;
            }
            
            const invoice = {
                id: invoiceId,
                date: new Date().toISOString(),
                customerId: customerId === 'walkin' ? null : parseInt(customerId),
                customerName,
                items: [...cart],
                subtotal: cart.reduce((sum, item) => sum + item.total, 0),
                tax: parseFloat(document.getElementById('taxAmount').textContent),
                discount: parseFloat(document.getElementById('discount').value) || 0,
                total,
                paymentMethod: document.getElementById('paymentMethod').value,
                amountPaid,
                change: amountPaid - total,
                status: 'completed'
            };
            
            // Update product quantities
            cart.forEach(item => {
                const productIndex = products.findIndex(p => p.id === item.productId);
                if (productIndex !== -1) {
                    products[productIndex].quantity -= item.quantity;
                }
            });
            
            // Add to invoices
            invoices.push(invoice);
            
            // Update customer balance if not walk-in
            if (customerId !== 'walkin') {
                const customerIndex = customers.findIndex(c => c.id === parseInt(customerId));
                if (customerIndex !== -1) {
                    // For simplicity, we'll just add to debt
                    customers[customerIndex].balance += total;
                }
            }
            
            // Save all data
            saveProducts();
            saveInvoices();
            saveCustomers();
            
            // Generate receipt
            generateReceipt(invoice);
            
            // Clear cart
            cart = [];
            updateCartDisplay();
            updateTotals();
            
            // Reset form
            document.getElementById('amountPaid').value = total.toFixed(2);
            document.getElementById('discount').value = 0;
            
            // Update dashboard
            updateDashboard();
            loadProductSelect();
            
            showAlert('تم', 'تم إتمام عملية البيع بنجاح');
        }

        // Generate receipt
        function generateReceipt(invoice = null) {
            if (!invoice && cart.length === 0) {
                showAlert('خطأ', 'لا توجد فاتورة لعرضها');
                return;
            }
            
            // If no invoice provided, use current cart to create a preview
            if (!invoice) {
                const subtotal = cart.reduce((sum, item) => sum + item.total, 0);
                const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
                const discount = parseFloat(document.getElementById('discount').value) || 0;
                const taxAmount = subtotal * (taxRate / 100);
                const total = subtotal + taxAmount - discount;
                
                invoice = {
                    id: 'معاينة',
                    date: new Date().toISOString(),
                    customerName: document.getElementById('customerSelect').value === 'walkin' ? 'زبون مباشر' : 'زبون',
                    items: [...cart],
                    subtotal,
                    tax: taxAmount,
                    discount,
                    total,
                    paymentMethod: document.getElementById('paymentMethod').value
                };
            }
            
            const receiptContent = document.getElementById('receiptContent');
            
            let itemsHtml = '';
            invoice.items.forEach(item => {
                itemsHtml += `
                    <div class="receipt-item">
                        <div>${item.name} × ${item.quantity}</div>
                        <div>${item.total.toFixed(2)} ر.س</div>
                    </div>
                `;
            });
            
            receiptContent.innerHTML = `
                <div class="receipt">
                    <div class="receipt-header">
                        <h2>${settings.storeName}</h2>
                        <p>${settings.storeAddress}</p>
                        <p>${settings.storePhone}</p>
                        <p>فاتورة #${invoice.id}</p>
                        <p>${new Date(invoice.date).toLocaleDateString('ar-SA')} ${new Date(invoice.date).toLocaleTimeString('ar-SA')}</p>
                    </div>
                    
                    <div class="receipt-items">
                        <div class="receipt-item">
                            <div><strong>الزبون:</strong></div>
                            <div>${invoice.customerName}</div>
                        </div>
                        <hr>
                        ${itemsHtml}
                    </div>
                    
                    <div class="receipt-item">
                        <div>الإجمالي الفرعي:</div>
                        <div>${invoice.subtotal.toFixed(2)} ر.س</div>
                    </div>
                    
                    <div class="receipt-item">
                        <div>الضريبة (${settings.defaultTax}%):</div>
                        <div>${invoice.tax.toFixed(2)} ر.س</div>
                    </div>
                    
                    ${invoice.discount > 0 ? `
                    <div class="receipt-item">
                        <div>الخصم:</div>
                        <div>-${invoice.discount.toFixed(2)} ر.س</div>
                    </div>
                    ` : ''}
                    
                    <div class="receipt-total">
                        <div>الإجمالي النهائي:</div>
                        <div>${invoice.total.toFixed(2)} ر.س</div>
                    </div>
                    
                    <div class="receipt-item">
                        <div>طريقة الدفع:</div>
                        <div>${invoice.paymentMethod === 'cash' ? 'نقدي' : invoice.paymentMethod === 'card' ? 'بطاقة ائتمان' : 'تحويل بنكي'}</div>
                    </div>
                    
                    ${invoice.amountPaid ? `
                    <div class="receipt-item">
                        <div>المبلغ المدفوع:</div>
                        <div>${invoice.amountPaid.toFixed(2)} ر.س</div>
                    </div>
                    
                    <div class="receipt-item">
                        <div>الباقي:</div>
                        <div>${invoice.change ? invoice.change.toFixed(2) : '0.00'} ر.س</div>
                    </div>
                    ` : ''}
                    
                    <hr>
                    <p style="text-align: center; margin-top: 20px;">شكراً لزيارتكم</p>
                </div>
            `;
            
            // Show receipt modal
            document.getElementById('receiptModal').style.display = 'flex';
        }

        // Print receipt
        function printReceipt() {
            const receiptElement = document.querySelector('.receipt');
            
            html2canvas(receiptElement).then(canvas => {
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>طباعة الفاتورة</title>');
                printWindow.document.write('<style>body { direction: rtl; font-family: "Cairo", sans-serif; }</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write('<img src="' + canvas.toDataURL() + '" style="width:100%;"/>');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.print();
            });
        }

        // Close receipt modal
        function closeReceiptModal() {
            document.getElementById('receiptModal').style.display = 'none';
        }

        // Open barcode scanner
        function openScanner() {
            document.getElementById('scannerOverlay').classList.add('active');
            document.getElementById('scannerResult').classList.add('d-none');
            
            // Simulate barcode scanning after 3 seconds
            setTimeout(() => {
                simulateBarcodeScan();
            }, 3000);
        }

        // Close scanner
        function closeScanner() {
            document.getElementById('scannerOverlay').classList.remove('active');
        }

        // Simulate barcode scanning (for demo)
        function simulateBarcodeScan() {
            // Pick a random product
            const randomProduct = products[Math.floor(Math.random() * products.length)];
            
            // Add to scan history
            const scanRecord = {
                timestamp: new Date().toISOString(),
                barcode: randomProduct.barcode,
                productName: randomProduct.name,
                price: randomProduct.price,
                quantity: randomProduct.quantity
            };
            
            scanHistory.unshift(scanRecord);
            if (scanHistory.length > 10) scanHistory = scanHistory.slice(0, 10);
            saveScanHistory();
            
            // Update scan history display
            updateScanHistory();
            
            // Show result
            document.getElementById('scannedProductInfo').innerHTML = `
                <p><strong>المنتج:</strong> ${randomProduct.name}</p>
                <p><strong>السعر:</strong> ${randomProduct.price.toFixed(2)} ر.س</p>
                <p><strong>المخزون:</strong> ${randomProduct.quantity}</p>
                <p><strong>الفئة:</strong> ${randomProduct.category}</p>
            `;
            
            document.getElementById('scannerResult').classList.remove('d-none');
            
            // Auto-add to cart if in POS tab
            const currentTab = document.querySelector('.nav-tab.active').getAttribute('data-tab');
            if (currentTab === 'pos') {
                addToCart(randomProduct.id, 1);
            }
        }

        // Update scan history
        function updateScanHistory() {
            const scanHistoryTable = document.getElementById('scanHistory');
            scanHistoryTable.innerHTML = '';
            
            scanHistory.forEach(scan => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(scan.timestamp).toLocaleTimeString('ar-SA')}</td>
                    <td>${scan.productName}</td>
                    <td>${scan.barcode}</td>
                    <td>${scan.price.toFixed(2)} ر.س</td>
                    <td>${scan.quantity}</td>
                `;
                scanHistoryTable.appendChild(row);
            });
        }

        // Load customers table
        function loadCustomersTable() {
            const customersTable = document.getElementById('customersTable');
            customersTable.innerHTML = '';
            
            customers.forEach(customer => {
                const balanceText = customer.balance.toFixed(2) + ' ر.س';
                const balanceColor = customer.balanceType === 'debt' ? 'var(--danger)' : 'var(--success)';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.name}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.email || '-'}</td>
                    <td style="color: ${balanceColor}; font-weight: 600;">${balanceText}</td>
                    <td>${new Date(customer.createdAt).toLocaleDateString('ar-SA')}</td>
                    <td>
                        <div class="d-flex gap-10">
                            <button class="btn btn-secondary btn-small" onclick="editCustomer(${customer.id})">تعديل</button>
                            <button class="btn btn-danger btn-small" onclick="deleteCustomer(${customer.id})">حذف</button>
                        </div>
                    </td>
                `;
                customersTable.appendChild(row);
            });
        }

        // Search customers
        function searchCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) ||
                customer.phone.includes(searchTerm) ||
                (customer.email && customer.email.toLowerCase().includes(searchTerm))
            );
            
            const customersTable = document.getElementById('customersTable');
            customersTable.innerHTML = '';
            
            filteredCustomers.forEach(customer => {
                const balanceText = customer.balance.toFixed(2) + ' ر.س';
                const balanceColor = customer.balanceType === 'debt' ? 'var(--danger)' : 'var(--success)';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.name}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.email || '-'}</td>
                    <td style="color: ${balanceColor}; font-weight: 600;">${balanceText}</td>
                    <td>${new Date(customer.createdAt).toLocaleDateString('ar-SA')}</td>
                    <td>
                        <div class="d-flex gap-10">
                            <button class="btn btn-secondary btn-small" onclick="editCustomer(${customer.id})">تعديل</button>
                            <button class="btn btn-danger btn-small" onclick="deleteCustomer(${customer.id})">حذف</button>
                        </div>
                    </td>
                `;
                customersTable.appendChild(row);
            });
        }

        // Filter customers by status
        function filterCustomers() {
            const status = document.getElementById('customerStatusFilter').value;
            let filteredCustomers = customers;
            
            if (status === 'debt') {
                filteredCustomers = customers.filter(c => c.balanceType === 'debt' && c.balance > 0);
            } else if (status === 'credit') {
                filteredCustomers = customers.filter(c => c.balanceType === 'credit' && c.balance > 0);
            } else if (status === 'active') {
                filteredCustomers = customers.filter(c => c.balance === 0);
            }
            
            const customersTable = document.getElementById('customersTable');
            customersTable.innerHTML = '';
            
            filteredCustomers.forEach(customer => {
                const balanceText = customer.balance.toFixed(2) + ' ر.س';
                const balanceColor = customer.balanceType === 'debt' ? 'var(--danger)' : 'var(--success)';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.name}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.email || '-'}</td>
                    <td style="color: ${balanceColor}; font-weight: 600;">${balanceText}</td>
                    <td>${new Date(customer.createdAt).toLocaleDateString('ar-SA')}</td>
                    <td>
                        <div class="d-flex gap-10">
                            <button class="btn btn-secondary btn-small" onclick="editCustomer(${customer.id})">تعديل</button>
                            <button class="btn btn-danger btn-small" onclick="deleteCustomer(${customer.id})">حذف</button>
                        </div>
                    </td>
                `;
                customersTable.appendChild(row);
            });
        }

        // Open customer modal
        function openCustomerModal(customerId = null) {
            currentCustomerId = customerId;
            const modal = document.getElementById('customerModal');
            const title = document.getElementById('customerModalTitle');
            
            if (customerId) {
                // Edit mode
                title.textContent = 'تعديل بيانات الزبون';
                const customer = customers.find(c => c.id === customerId);
                
                if (customer) {
                    document.getElementById('modalCustomerName').value = customer.name;
                    document.getElementById('modalCustomerPhone').value = customer.phone;
                    document.getElementById('modalCustomerEmail').value = customer.email || '';
                    document.getElementById('modalCustomerAddress').value = customer.address || '';
                    document.getElementById('modalCustomerBalance').value = Math.abs(customer.balance);
                    document.getElementById('modalBalanceType').value = customer.balanceType;
                }
            } else {
                // Add mode
                title.textContent = 'إضافة زبون جديد';
                document.getElementById('modalCustomerName').value = '';
                document.getElementById('modalCustomerPhone').value = '';
                document.getElementById('modalCustomerEmail').value = '';
                document.getElementById('modalCustomerAddress').value = '';
                document.getElementById('modalCustomerBalance').value = '0';
                document.getElementById('modalBalanceType').value = 'debt';
            }
            
            modal.style.display = 'flex';
        }

        // Close customer modal
        function closeCustomerModal() {
            document.getElementById('customerModal').style.display = 'none';
            currentCustomerId = null;
        }

        // Save customer
        function saveCustomer() {
            const name = document.getElementById('modalCustomerName').value;
            const phone = document.getElementById('modalCustomerPhone').value;
            const email = document.getElementById('modalCustomerEmail').value;
            const address = document.getElementById('modalCustomerAddress').value;
            const balance = parseFloat(document.getElementById('modalCustomerBalance').value) || 0;
            const balanceType = document.getElementById('modalBalanceType').value;
            
            // Validation
            if (!name || !phone) {
                showAlert('خطأ', 'يرجى ملء الحقول المطلوبة');
                return;
            }
            
            const balanceValue = balanceType === 'debt' ? balance : -balance;
            
            if (currentCustomerId) {
                // Update existing customer
                const index = customers.findIndex(c => c.id === currentCustomerId);
                if (index !== -1) {
                    customers[index] = {
                        ...customers[index],
                        name,
                        phone,
                        email,
                        address,
                        balance: balanceValue,
                        balanceType
                    };
                }
            } else {
                // Add new customer
                const newId = customers.length > 0 ? Math.max(...customers.map(c => c.id)) + 1 : 1;
                const newCustomer = {
                    id: newId,
                    name,
                    phone,
                    email,
                    address,
                    balance: balanceValue,
                    balanceType,
                    createdAt: new Date().toISOString()
                };
                customers.push(newCustomer);
            }
            
            saveCustomers();
            loadCustomersTable();
            loadCustomerSelect();
            updateDashboard();
            closeCustomerModal();
            
            showAlert('تم', 'تم حفظ بيانات الزبون بنجاح');
        }

        // Delete customer
        function deleteCustomer(customerId) {
            // Check if customer has invoices
            const hasInvoices = invoices.some(inv => inv.customerId === customerId);
            
            if (hasInvoices) {
                showAlert('خطأ', 'لا يمكن حذف زبون لديه فواتير مرتبطة');
                return;
            }
            
            if (confirm('هل أنت متأكد من حذف هذا الزبون؟')) {
                customers = customers.filter(c => c.id !== customerId);
                saveCustomers();
                loadCustomersTable();
                loadCustomerSelect();
                updateDashboard();
                showAlert('تم', 'تم حذف الزبون بنجاح');
            }
        }

        // Edit customer
        function editCustomer(customerId) {
            openCustomerModal(customerId);
        }

        // Load payments table
        function loadPaymentsTable() {
            const paymentsTable = document.getElementById('paymentsTable');
            paymentsTable.innerHTML = '';
            
            // Get all payments from invoices
            const payments = [];
            invoices.forEach(invoice => {
                payments.push({
                    date: invoice.date,
                    customerName: invoice.customerName,
                    amount: invoice.total,
                    type: 'بيع',
                    method: invoice.paymentMethod === 'cash' ? 'نقدي' : 
                           invoice.paymentMethod === 'card' ? 'بطاقة ائتمان' : 'تحويل بنكي',
                    reference: `فاتورة #${invoice.id}`
                });
            });
            
            // Sort by date (newest first)
            payments.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Show last 20 payments
            payments.slice(0, 20).forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(payment.date).toLocaleDateString('ar-SA')}</td>
                    <td>${payment.customerName}</td>
                    <td>${payment.amount.toFixed(2)} ر.س</td>
                    <td>${payment.type}</td>
                    <td>${payment.method}</td>
                    <td>${payment.reference}</td>
                `;
                paymentsTable.appendChild(row);
            });
        }

        // Load reports
        function loadReports() {
            const period = document.getElementById('reportPeriod').value;
            
            // Update report table
            updateReportTable(period);
            
            // Update charts
            updateReportCharts(period);
        }

        // Update report table
        function updateReportTable(period) {
            const reportTable = document.getElementById('reportTable');
            reportTable.innerHTML = '';
            
            // Calculate date range
            const endDate = new Date();
            let startDate = new Date();
            
            if (period === 'week') {
                startDate.setDate(startDate.getDate() - 7);
            } else if (period === 'month') {
                startDate.setMonth(startDate.getMonth() - 1);
            } else if (period === 'year') {
                startDate.setFullYear(startDate.getFullYear() - 1);
            }
            
            // Group invoices by date
            const invoicesByDate = {};
            invoices.forEach(invoice => {
                const invoiceDate = new Date(invoice.date);
                if (invoiceDate >= startDate && invoiceDate <= endDate) {
                    const dateStr = invoiceDate.toLocaleDateString('ar-SA');
                    
                    if (!invoicesByDate[dateStr]) {
                        invoicesByDate[dateStr] = {
                            date: dateStr,
                            count: 0,
                            totalSales: 0,
                            totalTax: 0,
                            totalProfit: 0
                        };
                    }
                    
                    invoicesByDate[dateStr].count++;
                    invoicesByDate[dateStr].totalSales += invoice.total;
                    invoicesByDate[dateStr].totalTax += invoice.tax;
                    
                    // Calculate profit
                    const profit = invoice.items.reduce((sum, item) => {
                        const product = products.find(p => p.id === item.productId);
                        const cost = product ? product.cost * item.quantity : 0;
                        return sum + (item.total - cost);
                    }, 0);
                    
                    invoicesByDate[dateStr].totalProfit += profit;
                }
            });
            
            // Convert to array and sort by date
            const reportData = Object.values(invoicesByDate).sort((a, b) => {
                // Parse Arabic date for sorting
                return new Date(b.date.split('/').reverse().join('-')) - 
                       new Date(a.date.split('/').reverse().join('-'));
            });
            
            // Add rows to table
            reportData.forEach(data => {
                const avgInvoice = data.count > 0 ? data.totalSales / data.count : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.date}</td>
                    <td>${data.count}</td>
                    <td>${data.totalSales.toFixed(2)} ر.س</td>
                    <td>${avgInvoice.toFixed(2)} ر.س</td>
                    <td>${data.totalTax.toFixed(2)} ر.س</td>
                    <td>${data.totalProfit.toFixed(2)} ر.س</td>
                `;
                reportTable.appendChild(row);
            });
        }

        // Update report charts
        function updateReportCharts(period) {
            // Daily sales chart
            const dailySalesCtx = document.getElementById('dailySalesChart').getContext('2d');
            
            // Calculate date range
            const endDate = new Date();
            let startDate = new Date();
            let labels = [];
            let salesData = [];
            
            if (period === 'week') {
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('ar-SA', { weekday: 'short' }));
                    
                    const daySales = invoices.filter(inv => {
                        const invDate = new Date(inv.date).toDateString();
                        return invDate === date.toDateString();
                    }).reduce((sum, inv) => sum + inv.total, 0);
                    
                    salesData.push(daySales);
                }
            } else if (period === 'month') {
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.getDate().toString());
                    
                    const daySales = invoices.filter(inv => {
                        const invDate = new Date(inv.date).toDateString();
                        return invDate === date.toDateString();
                    }).reduce((sum, inv) => sum + inv.total, 0);
                    
                    salesData.push(daySales);
                }
            }
            
            if (window.dailySalesChart) window.dailySalesChart.destroy();
            
            window.dailySalesChart = new Chart(dailySalesCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'المبيعات',
                        data: salesData,
                        backgroundColor: 'rgba(108, 99, 255, 0.7)',
                        borderColor: 'var(--primary)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'var(--text-secondary)' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'var(--text-secondary)' }
                        }
                    }
                }
            });
            
            // Top products chart
            const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
            
            // Calculate top selling products
            const productSales = {};
            invoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    if (!productSales[item.name]) {
                        productSales[item.name] = 0;
                    }
                    productSales[item.name] += item.quantity;
                });
            });
            
            const sortedProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const productNames = sortedProducts.map(p => p[0]);
            const productQuantities = sortedProducts.map(p => p[1]);
            
            if (window.topProductsChart) window.topProductsChart.destroy();
            
            window.topProductsChart = new Chart(topProductsCtx, {
                type: 'horizontalBar',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'الكمية المباعة',
                        data: productQuantities,
                        backgroundColor: [
                            'rgba(108, 99, 255, 0.7)',
                            'rgba(255, 101, 132, 0.7)',
                            'rgba(66, 226, 184, 0.7)',
                            'rgba(243, 156, 18, 0.7)',
                            'rgba(231, 76, 60, 0.7)'
                        ],
                        borderColor: [
                            'var(--primary)',
                            'var(--secondary)',
                            'var(--accent)',
                            'var(--warning)',
                            'var(--danger)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'var(--text-secondary)' }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'var(--text-secondary)' }
                        }
                    }
                }
            });
        }

        // Export report
        function exportReport() {
            const period = document.getElementById('reportPeriod').value;
            const reportData = {
                period: period,
                generatedAt: new Date().toISOString(),
                summary: {
                    totalSales: invoices.reduce((sum, inv) => sum + inv.total, 0),
                    totalInvoices: invoices.length,
                    totalCustomers: customers.length,
                    totalProducts: products.length
                },
                invoices: invoices,
                products: products,
                customers: customers
            };
            
            const dataStr = JSON.stringify(reportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `تقرير_فواتير_${period}_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showAlert('تم', 'تم تصدير التقرير بنجاح');
        }

        // Load settings
        function loadSettings() {
            document.getElementById('storeName').value = settings.storeName;
            document.getElementById('storeAddress').value = settings.storeAddress;
            document.getElementById('storePhone').value = settings.storePhone;
            document.getElementById('defaultTax').value = settings.defaultTax;
            
            // Update tax rate in POS if different from default
            document.getElementById('taxRate').value = settings.defaultTax;
        }

        // Save settings
        function saveSettings() {
            settings.storeName = document.getElementById('storeName').value;
            settings.storeAddress = document.getElementById('storeAddress').value;
            settings.storePhone = document.getElementById('storePhone').value;
            settings.defaultTax = parseFloat(document.getElementById('defaultTax').value) || 15;
            
            // Update tax rate in POS
            document.getElementById('taxRate').value = settings.defaultTax;
            
            localStorage.setItem('fawateer_settings', JSON.stringify(settings));
            showAlert('تم', 'تم حفظ الإعدادات بنجاح');
        }

        // Export all data
        function exportData() {
            const exportData = {
                exportedAt: new Date().toISOString(),
                products: products,
                customers: customers,
                invoices: invoices,
                settings: settings,
                scanHistory: scanHistory
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `نسخة_احتياطية_فواتير_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showAlert('تم', 'تم تصدير جميع البيانات بنجاح');
        }

        // Import data
        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('خطأ', 'يرجى اختيار ملف للاستيراد');
                return;
            }
            
            if (!confirm('تحذير: هذا سوف يستبدل جميع البيانات الحالية. هل أنت متأكد؟')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.products) products = importedData.products;
                    if (importedData.customers) customers = importedData.customers;
                    if (importedData.invoices) invoices = importedData.invoices;
                    if (importedData.settings) settings = importedData.settings;
                    if (importedData.scanHistory) scanHistory = importedData.scanHistory;
                    
                    // Save all data
                    saveProducts();
                    saveCustomers();
                    saveInvoices();
                    saveSettings();
                    saveScanHistory();
                    
                    // Reload all tables
                    loadInventoryTable();
                    loadCustomersTable();
                    loadPaymentsTable();
                    loadProductSelect();
                    loadCustomerSelect();
                    updateDashboard();
                    loadReports();
                    updateSystemInfo();
                    loadSettings();
                    
                    showAlert('تم', 'تم استيراد البيانات بنجاح');
                    
                    // Reset file input
                    fileInput.value = '';
                } catch (error) {
                    showAlert('خطأ', 'خطأ في تحليل الملف. يرجى التأكد من صحة تنسيق JSON');
                }
            };
            
            reader.readAsText(file);
        }

        // Reset system
        function resetSystem() {
            if (!confirm('تحذير: هذا سوف يحذف جميع البيانات ولا يمكن التراجع عنه. هل أنت متأكد؟')) {
                return;
            }
            
            if (!confirm('للتأكيد النهائي، اكتب "نعم" للحذف:')) {
                return;
            }
            
            // Clear all data
            products = [];
            customers = [];
            invoices = [];
            scanHistory = [];
            cart = [];
            
            // Reset settings to defaults
            settings = {
                storeName: "متجر فواتير",
                storeAddress: "الرياض، المملكة العربية السعودية",
                storePhone: "+966 500 000 000",
                defaultTax: 15
            };
            
            // Save all empty data
            saveProducts();
            saveCustomers();
            saveInvoices();
            saveSettings();
            saveScanHistory();
            
            // Reinitialize with sample data
            initSampleData();
            
            // Reload all tables
            loadInventoryTable();
            loadCustomersTable();
            loadPaymentsTable();
            loadProductSelect();
            loadCustomerSelect();
            updateDashboard();
            loadReports();
            updateSystemInfo();
            loadSettings();
            
            showAlert('تم', 'تم إعادة تعيين النظام بنجاح');
        }

        // Update system info
        function updateSystemInfo() {
            document.getElementById('productsCount').textContent = products.length;
            document.getElementById('invoicesCount').textContent = invoices.length;
            document.getElementById('customersCount').textContent = customers.length;
        }

        // Show alert modal
        function showAlert(title, message) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').style.display = 'flex';
        }

        // Close alert modal
        function closeAlertModal() {
            document.getElementById('alertModal').style.display = 'none';
        }

        // Save functions
        function saveProducts() {
            localStorage.setItem('fawateer_products', JSON.stringify(products));
        }

        function saveCustomers() {
            localStorage.setItem('fawateer_customers', JSON.stringify(customers));
        }

        function saveInvoices() {
            localStorage.setItem('fawateer_invoices', JSON.stringify(invoices));
        }

        function saveScanHistory() {
            localStorage.setItem('fawateer_scan_history', JSON.stringify(scanHistory));
        }

        function saveSettings() {
            localStorage.setItem('fawateer_settings', JSON.stringify(settings));
        }

        // Search products for POS
        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            if (searchTerm.length < 2) return;
            
            const results = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.barcode.includes(searchTerm)
            );
            
            if (results.length > 0) {
                // Add first result to cart
                addToCart(results[0].id, 1);
                document.getElementById('productSearch').value = '';
            }
        }

        // Initialize scan history display
        updateScanHistory();
    </script>
</body>
</html>
